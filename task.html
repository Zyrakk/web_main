<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <link rel="icon" href="/sources/favicon_task.ico" type="image/x-icon" />
    <title>Z - SYSTEM</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;600;700&family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Core Palette */
        --bg-dark: #030507;
        --bg-panel: rgba(10, 20, 24, 0.75);
        --grid-line: rgba(0, 246, 169, 0.1);
        
        /* Neon Accents */
        --neon-green: #00f6a9;
        --neon-blue: #00a7ff;
        --neon-purple: #b026ff;
        --neon-pink: #ff0080;
        --neon-orange: #ff6b00;
        --neon-red: #ff2a2a;
        
        /* Functional */
        --text-main: #e0fbfc;
        --text-muted: #648c8c;
        --border-dim: rgba(0, 246, 169, 0.2);
        --border-bright: rgba(0, 246, 169, 0.6);
        
        /* Sizes */
        --corner: 12px;
        --gap: 20px;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #020405;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--neon-green);
        border: 2px solid #020405;
      }

      html, body {
        height: 100%;
        background: var(--bg-dark);
        margin: 0;
        color: var(--text-main);
        font-family: "Rajdhani", sans-serif; 
        /* Rajdhani is cleaner for reading, VT323/PressStart for headers */
        overflow-x: hidden;
        image-rendering: pixelated;
      }

      /* --- BACKGROUND FX --- */
      
      .scanlines {
        position: fixed;
        inset: 0;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                    linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 3px, 3px 100%;
        pointer-events: none;
        z-index: 1000;
        opacity: 0.6;
      }

      .cyber-grid {
        position: fixed;
        width: 200vw;
        height: 200vh;
        left: -50%;
        top: -50%;
        background-image: 
          linear-gradient(var(--grid-line) 1px, transparent 1px),
          linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
        background-size: 40px 40px;
        transform: perspective(500px) rotateX(60deg);
        animation: gridMove 20s linear infinite;
        z-index: 0;
        mask-image: radial-gradient(circle at center, black 0%, transparent 70%);
      }

      @keyframes gridMove {
        0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
        100% { transform: perspective(500px) rotateX(60deg) translateY(40px); }
      }

      /* --- LAYOUT --- */
      
      .container {
        position: relative;
        z-index: 10;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 20px;
        background: rgba(3, 5, 7, 0.8);
        border: 1px solid var(--border-dim);
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(0, 246, 169, 0.05);
        clip-path: polygon(
          0 0, 
          100% 0, 
          100% calc(100% - 15px), 
          calc(100% - 15px) 100%, 
          0 100%
        );
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo-box {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--neon-pink), var(--neon-blue));
        display: grid;
        place-items: center;
        font-family: "Press Start 2P";
        font-size: 24px;
        color: white;
        text-shadow: 2px 2px 0px black;
        box-shadow: 0 0 15px var(--neon-pink);
        clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
      }

      h1 {
        margin: 0;
        font-family: "Press Start 2P";
        font-size: clamp(16px, 2vw, 24px);
        background: linear-gradient(90deg, #fff, var(--neon-green));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
        text-transform: uppercase;
      }

      /* --- BUTTONS --- */

      .btn {
        font-family: "VT323", monospace;
        font-size: 20px;
        text-transform: uppercase;
        letter-spacing: 1px;
        background: rgba(0, 246, 169, 0.1);
        color: var(--neon-green);
        border: 1px solid var(--neon-green);
        padding: 8px 24px;
        cursor: pointer;
        transition: all 0.2s;
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn:hover {
        background: var(--neon-green);
        color: #000;
        box-shadow: 0 0 20px var(--neon-green);
        text-shadow: none;
      }

      .btn.secondary {
        border-color: var(--neon-blue);
        color: var(--neon-blue);
        background: rgba(0, 167, 255, 0.1);
      }
      .btn.secondary:hover {
        background: var(--neon-blue);
        color: #000;
        box-shadow: 0 0 20px var(--neon-blue);
      }

      .btn.danger {
        border-color: var(--neon-red);
        color: var(--neon-red);
        background: rgba(255, 42, 42, 0.1);
      }
      .btn.danger:hover {
        background: var(--neon-red);
        color: #fff;
        box-shadow: 0 0 20px var(--neon-red);
      }

      /* --- TASK GRID --- */

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 25px;
        padding-bottom: 100px;
      }

      /* --- CARDS --- */

      .card {
        position: relative;
        background: var(--bg-panel);
        border: 1px solid var(--border-dim);
        backdrop-filter: blur(8px);
        padding: 2px; /* For border gradient space */
        transition: transform 0.2s, box-shadow 0.2s;
        /* Custom shape */
        clip-path: polygon(
          20px 0, 100% 0, 
          100% calc(100% - 20px), 
          calc(100% - 20px) 100%, 
          0 100%, 0 20px
        );
      }
      
      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 100%);
        pointer-events: none;
        z-index: 0;
      }

      /* Top Color Bar */
      .card-accent {
        height: 4px;
        width: 100%;
        background: linear-gradient(90deg, var(--c1, var(--neon-green)), var(--c2, var(--neon-blue)));
        box-shadow: 0 2px 10px var(--c1);
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        border-color: var(--border-bright);
      }

      .card.focused {
        border: 1px solid var(--neon-orange);
        box-shadow: 0 0 30px rgba(255, 107, 0, 0.15), inset 0 0 20px rgba(255, 107, 0, 0.05);
      }
      
      .card-inner {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        position: relative;
        z-index: 1;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
      }

      .card-title {
        font-family: "Press Start 2P";
        font-size: 14px;
        line-height: 1.4;
        color: #fff;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      }

      .badges {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
      }

      .chip {
        font-family: "VT323";
        font-size: 14px;
        text-transform: uppercase;
        padding: 2px 8px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--text-muted);
        letter-spacing: 1px;
      }
      .chip.focus {
        background: var(--neon-orange);
        color: black;
        font-weight: bold;
        border-color: var(--neon-orange);
        box-shadow: 0 0 10px var(--neon-orange);
      }
      .chip.done {
        background: var(--neon-green);
        color: black;
        border-color: var(--neon-green);
      }

      /* Description Fix */
      .card-desc {
        color: var(--text-muted);
        font-size: 18px; /* Bigger font for readability */
        line-height: 1.3;
        font-family: "VT323";
        /* Key fix for line breaks: */
        white-space: pre-wrap; 
        word-break: break-word;
        background: rgba(0,0,0,0.3);
        padding: 10px;
        border-left: 2px solid var(--border-dim);
      }

      /* Progress Bar */
      .progress-container {
        position: relative;
      }
      .progress-track {
        height: 12px;
        background: #000;
        border: 1px solid var(--border-dim);
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: var(--w);
        background: linear-gradient(90deg, var(--c1), var(--c2));
        position: relative;
        transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        box-shadow: 0 0 15px var(--c1);
      }
      /* Animated stripes on progress bar */
      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0; left: 0; bottom: 0; right: 0;
        background-image: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.15) 25%,
          transparent 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.15) 50%,
          rgba(255, 255, 255, 0.15) 75%,
          transparent 75%,
          transparent
        );
        background-size: 20px 20px;
        animation: stripeMove 1s linear infinite;
      }
      @keyframes stripeMove {
        0% { background-position: 0 0; }
        100% { background-position: 20px 0; }
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        font-family: "VT323";
        font-size: 18px;
        margin-top: 5px;
        color: var(--text-main);
      }

      .countdown {
        font-family: "Press Start 2P";
        font-size: 10px;
        color: var(--neon-blue);
        margin-top: 4px;
        text-align: right;
      }

      .card-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: flex-end;
        border-top: 1px solid rgba(255,255,255,0.05);
        padding-top: 10px;
      }
      
      .icon-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 5px;
        transition: transform 0.2s, color 0.2s;
      }
      .icon-btn:hover {
        color: #fff;
        transform: scale(1.2);
      }
      .icon-btn svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }

      /* Dragging styles */
      .dragging { opacity: 0.5; transform: scale(0.95); }
      .card.drop-before { border-top: 4px solid var(--neon-green); }
      .card.drop-after { border-bottom: 4px solid var(--neon-green); }

      /* --- FAB --- */
      .fab-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 50;
      }
      #addTaskBtn {
        width: 60px;
        height: 60px;
        border-radius: 0;
        font-size: 32px;
        padding: 0;
        background: var(--neon-green);
        color: #000;
        box-shadow: 0 0 30px rgba(0, 246, 169, 0.4);
        clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
      }

      /* --- MODAL --- */
      
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
        display: none;
        place-items: center;
        z-index: 200;
        padding: 20px;
      }
      .modal.show { display: grid; }

      .modal-content {
        background: #080f12;
        border: 2px solid var(--neon-green);
        width: 100%;
        max-width: 600px;
        padding: 30px;
        box-shadow: 0 0 50px rgba(0, 246, 169, 0.15);
        position: relative;
        /* Cyber corners */
        clip-path: polygon(
          0 0, 100% 0, 
          100% calc(100% - 30px), 
          calc(100% - 30px) 100%, 
          0 100%
        );
      }
      
      .modal-content::before {
        content: "SYSTEM_EDIT_MODE // V.2.0";
        position: absolute;
        top: -12px;
        left: 20px;
        background: #080f12;
        padding: 0 10px;
        color: var(--neon-green);
        font-family: "VT323";
        font-size: 18px;
      }

      .form-group {
        margin-bottom: 20px;
      }
      
      label {
        display: block;
        font-family: "Press Start 2P";
        font-size: 10px;
        color: var(--neon-blue);
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      input[type="text"],
      textarea,
      select,
      input[type="datetime-local"] {
        width: 100%;
        background: rgba(255,255,255,0.03);
        border: 1px solid #333;
        color: #fff;
        padding: 12px;
        font-family: "VT323";
        font-size: 20px;
        outline: none;
        transition: border 0.2s;
      }
      input:focus, textarea:focus, select:focus {
        border-color: var(--neon-green);
        box-shadow: 0 0 15px rgba(0,246,169,0.1);
      }
      
      textarea {
        min-height: 120px;
        resize: vertical;
        white-space: pre-wrap;
      }

      /* Custom Range Slider */
      input[type=range] {
        width: 100%;
        -webkit-appearance: none;
        background: transparent;
      }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 8px;
        background: #333;
        border: 1px solid #555;
      }
      input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 24px;
        width: 12px;
        background: var(--neon-green);
        margin-top: -9px;
        box-shadow: 0 0 10px var(--neon-green);
        cursor: grab;
      }

      /* Color Palette Picker */
      .palette-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .swatch {
        height: 40px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.2s;
        background: linear-gradient(135deg, var(--s1), var(--s2));
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      }
      .swatch:hover {
        transform: scale(1.1);
        border-color: #fff;
      }
      .swatch.active {
        border-color: #fff;
        box-shadow: 0 0 15px rgba(255,255,255,0.5);
        transform: scale(1.1);
      }
      .hidden-inputs {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        opacity: 0.5; /* Keeping them semi-visible for custom tweaks if needed */
        transform: scale(0.9);
        transform-origin: left;
      }
      .hidden-inputs input {
        font-size: 14px; 
        padding: 5px;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #111;
        border: 1px solid var(--neon-green);
        color: var(--neon-green);
        padding: 15px 30px;
        font-family: "Press Start 2P";
        font-size: 10px;
        z-index: 300;
        opacity: 0;
        transition: all 0.3s;
        box-shadow: 0 0 30px rgba(0,246,169,0.2);
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      /* Admin controls visibility */
      .admin-only { display: none !important; }
      body.admin-on .admin-only { display: flex !important; }
      
      /* Viewer specific */
      .viewer-tag {
        position: absolute;
        top: 10px;
        right: 10px;
        color: var(--neon-orange);
      }

    </style>
  </head>

  <body>
    <div class="cyber-grid"></div>
    <div class="scanlines"></div>
    <canvas id="confettiCanvas" style="position:fixed;inset:0;pointer-events:none;z-index:500;"></canvas>

    <div class="container">
      <header>
        <div class="brand">
          <div class="logo-box">Z</div>
          <h1>System<span style="color:var(--neon-green)">_Tasks</span></h1>
        </div>
        <div style="display:flex; gap:15px;">
          <a class="btn secondary" href="/admin/task.html">Admin</a>
          <a class="btn secondary admin-only" href="/task.html">Viewer</a>
        </div>
      </header>

      <div class="grid" id="taskGrid">
        </div>

      <div class="fab-container admin-only">
        <button id="addTaskBtn" class="btn">+</button>
      </div>
    </div>

    <div class="modal" id="editModal">
      <div class="modal-content">
        <h3 id="editorTitle" style="margin-top:0; font-family:'Press Start 2P'; color:white;">EDIT TASK</h3>
        
        <div class="form-group">
          <label>Task Title</label>
          <input type="text" id="taskTitle" placeholder="Operation Name..." />
        </div>

        <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
          <div>
            <label>Mode</label>
            <select id="taskMode">
              <option value="manual">Manual %</option>
              <option value="time">Time Auto</option>
            </select>
          </div>
          <div id="manualGroup">
            <label>Progress: <span id="manualValue" style="color:var(--neon-green)">0%</span></label>
            <input type="range" id="taskPercent" min="0" max="100" value="0">
          </div>
        </div>

        <div id="timeGroup" class="form-group" style="display:none;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
              <label>Start Time</label>
              <input type="datetime-local" id="taskStart">
            </div>
            <div>
              <label>End Time</label>
              <input type="datetime-local" id="taskEnd">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Details / Notes (Line breaks supported)</label>
          <textarea id="taskDesc" placeholder="Enter mission details..."></textarea>
        </div>

        <div class="form-group">
          <label>Theme Color</label>
          <div class="palette-grid" id="paletteContainer">
            </div>
          <div class="hidden-inputs">
            <input type="text" id="taskColor1" placeholder="#Hex1">
            <input type="text" id="taskColor2" placeholder="#Hex2">
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:30px;">
          <button class="btn danger" id="deleteTaskBtn">Delete</button>
          <div style="display:flex; gap:10px;">
            <button class="btn secondary" id="cancelEdit">Cancel</button>
            <button class="btn" id="saveTask">SAVE SYSTEM</button>
          </div>
        </div>

      </div>
    </div>

    <div class="toast" id="toast">Operation Successful</div>

    <script>
      // --- CONFIG & UTILS ---
      const ADMIN_MODE = location.pathname.startsWith("/admin");
      const isAdmin = () => document.body.classList.contains("admin-on"); // Modified check to rely on Auth state

      // Neon Palette Presets for the picker
      const PRESETS = [
        ["#00f6a9", "#00a7ff"], // Cyan / Blue
        ["#ff0080", "#b026ff"], // Pink / Purple
        ["#ff6b00", "#ff2a2a"], // Orange / Red
        ["#a8ff00", "#00f6a9"], // Lime / Teal
        ["#00a7ff", "#ff0080"], // Blue / Pink
        ["#b026ff", "#00f6a9"], // Purple / Mint
        ["#ffffff", "#999999"], // Monochrome
        ["#ffd54d", "#ff6b00"]  // Gold / Orange
      ];

      let tasks = [];
      let editingId = null;
      let draggingId = null;
      let serverVersion = 0;
      let ws = null;

      // --- DOM ELEMENTS ---
      const els = {
        grid: document.getElementById("taskGrid"),
        editModal: document.getElementById("editModal"),
        editorTitle: document.getElementById("editorTitle"),
        title: document.getElementById("taskTitle"),
        desc: document.getElementById("taskDesc"),
        mode: document.getElementById("taskMode"),
        manualGroup: document.getElementById("manualGroup"),
        timeGroup: document.getElementById("timeGroup"),
        percent: document.getElementById("taskPercent"),
        manualValue: document.getElementById("manualValue"),
        start: document.getElementById("taskStart"),
        end: document.getElementById("taskEnd"),
        c1: document.getElementById("taskColor1"),
        c2: document.getElementById("taskColor2"),
        palette: document.getElementById("paletteContainer"),
        saveTask: document.getElementById("saveTask"),
        cancelEdit: document.getElementById("cancelEdit"),
        deleteTask: document.getElementById("deleteTaskBtn"),
        addTaskBtn: document.getElementById("addTaskBtn"),
        toast: document.getElementById("toast"),
        confetti: document.getElementById("confettiCanvas")
      };

      // --- INITIALIZATION ---
      
      // Generate Color Palette UI
      function initPalette() {
        els.palette.innerHTML = "";
        PRESETS.forEach(([c1, c2]) => {
          const div = document.createElement("div");
          div.className = "swatch";
          div.style.setProperty("--s1", c1);
          div.style.setProperty("--s2", c2);
          div.onclick = () => {
            els.c1.value = c1;
            els.c2.value = c2;
            // Visual feedback
            document.querySelectorAll(".swatch").forEach(s => s.classList.remove("active"));
            div.classList.add("active");
          };
          els.palette.appendChild(div);
        });
      }
      initPalette();

      function updatePaletteSelection() {
        // Highlight the matching swatch if manual colors match a preset
        const currentC1 = els.c1.value;
        const currentC2 = els.c2.value;
        document.querySelectorAll(".swatch").forEach((s, idx) => {
          s.classList.remove("active");
          if (PRESETS[idx][0] === currentC1 && PRESETS[idx][1] === currentC2) {
            s.classList.add("active");
          }
        });
      }

      // --- RENDER LOGIC ---

      const computePct = (t) => {
        if (t.mode !== "time") return Math.max(0, Math.min(100, t.percent || 0));
        if (!t.start || !t.end) return 0;
        const s = new Date(t.start).getTime();
        const e = new Date(t.end).getTime();
        const n = new Date().getTime();
        if (e <= s) return 100;
        const p = ((n - s) / (e - s)) * 100;
        return Math.max(0, Math.min(100, p));
      };

      const fmtCountdown = (t) => {
        if (t.mode !== "time" || !t.start || !t.end) return "";
        const now = new Date().getTime();
        const s = new Date(t.start).getTime();
        const e = new Date(t.end).getTime();
        
        if (now < s) return "STARTS IN: " + humanize(s - now);
        if (now >= e) return "STATUS: COMPLETED";
        return "T-MINUS: " + humanize(e - now);
      };

      const humanize = (ms) => {
        const sec = Math.floor(ms / 1000);
        const d = Math.floor(sec / 86400);
        const h = Math.floor((sec % 86400) / 3600);
        const m = Math.floor((sec % 3600) / 60);
        return `${d}d ${h}h ${m}m`;
      };

      const escapeHtml = (s) => (s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

      function render() {
        const admin = isAdmin();
        
        if (!tasks.length) {
          els.grid.innerHTML = `
            <div style="grid-column: 1/-1; text-align:center; padding:50px; border:1px dashed var(--border-dim); color:var(--text-muted); font-family:'VT323'; font-size:24px;">
              SYSTEM IDLE // NO TASKS DETECTED
            </div>`;
          return;
        }

        els.grid.innerHTML = tasks.map(t => {
          const pct = computePct(t);
          const done = pct >= 100;
          const focused = !!t.focused;
          
          return `
          <div class="card ${focused ? 'focused' : ''}" 
               data-id="${t.id}"
               style="--c1:${t.c1}; --c2:${t.c2}"
               draggable="${admin ? 'true' : 'false'}">
               
            <div class="card-accent"></div>
            
            <div class="card-inner">
              <div class="card-header">
                <h3 class="card-title">${escapeHtml(t.title)}</h3>
                ${!admin && focused ? `<div class="viewer-tag"><svg style="width:16px;height:16px;fill:currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm0 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/></svg></div>` : ''}
                <div class="badges">
                  ${admin && t.mode === 'time' ? '<span class="chip">AUTO</span>' : ''}
                  ${admin && focused ? '<span class="chip focus">PRIORITY</span>' : ''}
                  ${done ? '<span class="chip done">DONE</span>' : ''}
                </div>
              </div>

              ${t.desc ? `<div class="card-desc">${escapeHtml(t.desc)}</div>` : ''}

              <div class="progress-container">
                <div class="progress-track">
                  <div class="progress-fill" style="--w:${pct}%"></div>
                </div>
                <div class="progress-info">
                  <span>PROGRESS</span>
                  <span>${Math.round(pct)}%</span>
                </div>
                <div class="countdown">${fmtCountdown(t)}</div>
              </div>

              <div class="card-actions admin-only">
                <button class="icon-btn" data-action="focus" title="Toggle Priority">
                  <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                </button>
                <button class="icon-btn" data-action="edit" title="Edit">
                  <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </button>
                <button class="icon-btn" data-action="delete" title="Delete" style="color:var(--neon-red)">
                  <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
              </div>
            </div>
          </div>`;
        }).join('');

        attachEvents();
      }

      function attachEvents() {
        document.querySelectorAll(".card").forEach(card => {
          const id = card.getAttribute("data-id");
          
          // Button clicks
          card.querySelectorAll("[data-action]").forEach(btn => {
            btn.addEventListener("click", e => {
              e.stopPropagation();
              handleAction(id, btn.getAttribute("data-action"));
            });
          });

          // Drag and Drop (Admin only)
          if (isAdmin()) {
            card.addEventListener("dragstart", e => {
              draggingId = id;
              e.currentTarget.classList.add("dragging");
              e.dataTransfer.effectAllowed = "move";
              e.dataTransfer.setData("text/plain", id);
            });
            card.addEventListener("dragend", e => {
              e.currentTarget.classList.remove("dragging");
              draggingId = null;
            });
            card.addEventListener("dragover", e => {
              e.preventDefault();
              if (!draggingId || draggingId === id) return;
              const rect = card.getBoundingClientRect();
              const mid = rect.top + rect.height / 2;
              const isTop = e.clientY < mid;
              card.classList.remove("drop-before", "drop-after");
              card.classList.add(isTop ? "drop-before" : "drop-after");
            });
            card.addEventListener("dragleave", () => {
              card.classList.remove("drop-before", "drop-after");
            });
            card.addEventListener("drop", e => {
              e.preventDefault();
              card.classList.remove("drop-before", "drop-after");
              const fromId = e.dataTransfer.getData("text/plain");
              if (fromId && fromId !== id) {
                const rect = card.getBoundingClientRect();
                const isTop = e.clientY < (rect.top + rect.height / 2);
                reorderTasks(fromId, id, isTop);
              }
            });
          }
        });
      }

      function reorderTasks(fromId, toId, before) {
        const fromIdx = tasks.findIndex(t => t.id === fromId);
        const toIdx = tasks.findIndex(t => t.id === toId);
        if (fromIdx < 0 || toIdx < 0) return;
        
        const [moved] = tasks.splice(fromIdx, 1);
        const newIdx = tasks.findIndex(t => t.id === toId) + (before ? 0 : 1);
        tasks.splice(newIdx, 0, moved);
        render();
        saveAll("Order Updated");
      }

      function handleAction(id, action) {
        const t = tasks.find(x => x.id === id);
        if (!t) return;
        
        if (action === "edit") {
          editingId = id;
          els.editorTitle.textContent = "EDIT PROTOCOL";
          els.title.value = t.title;
          els.desc.value = t.desc || "";
          els.mode.value = t.mode;
          els.percent.value = Math.round(t.percent || 0);
          els.manualValue.textContent = els.percent.value + "%";
          
          // Handle Date
          const toInput = d => d ? new Date(d).toISOString().slice(0,16) : "";
          els.start.value = toInput(t.start);
          els.end.value = toInput(t.end);
          
          els.c1.value = t.c1 || "#00f6a9";
          els.c2.value = t.c2 || "#00a7ff";
          
          updatePaletteSelection();
          els.mode.dispatchEvent(new Event('change'));
          toggleModal(true);
        } else if (action === "delete") {
          if (confirm("TERMINATE THIS TASK?")) {
            tasks = tasks.filter(x => x.id !== id);
            render();
            saveAll("Task Terminated");
          }
        } else if (action === "focus") {
          t.focused = !t.focused;
          t.updatedAt = Date.now();
          render();
          saveAll(t.focused ? "Priority Set" : "Priority Cleared");
        }
      }

      // --- LOGIC ---

      els.addTaskBtn.addEventListener("click", () => {
        editingId = null;
        els.editorTitle.textContent = "INITIATE PROTOCOL";
        els.title.value = "";
        els.desc.value = "";
        els.mode.value = "manual";
        els.percent.value = 0;
        els.manualValue.textContent = "0%";
        els.start.value = "";
        els.end.value = "";
        // Default colors
        els.c1.value = "#00f6a9";
        els.c2.value = "#00a7ff";
        updatePaletteSelection();
        els.mode.dispatchEvent(new Event('change'));
        toggleModal(true);
      });

      els.saveTask.addEventListener("click", () => {
        const title = els.title.value.trim();
        if (!title) return showToast("ERROR: Title Required");
        
        const mode = els.mode.value;
        const newTask = {
          id: editingId || Math.random().toString(36).slice(2),
          title,
          desc: els.desc.value,
          mode,
          percent: mode === "manual" ? parseInt(els.percent.value) : 0,
          start: mode === "time" && els.start.value ? new Date(els.start.value).toISOString() : null,
          end: mode === "time" && els.end.value ? new Date(els.end.value).toISOString() : null,
          c1: els.c1.value,
          c2: els.c2.value,
          updatedAt: Date.now(),
          focused: editingId ? (tasks.find(t=>t.id===editingId)?.focused || false) : false
        };

        if (editingId) {
          const idx = tasks.findIndex(t => t.id === editingId);
          if (idx >= 0) tasks[idx] = { ...tasks[idx], ...newTask };
        } else {
          tasks.unshift(newTask);
        }
        
        toggleModal(false);
        render();
        saveAll("Data Saved");
      });

      // --- UI HELPERS ---

      els.mode.addEventListener("change", () => {
        const isTime = els.mode.value === "time";
        els.manualGroup.style.display = isTime ? "none" : "block";
        els.timeGroup.style.display = isTime ? "block" : "none";
      });

      els.percent.addEventListener("input", (e) => {
        els.manualValue.textContent = e.target.value + "%";
      });

      els.cancelEdit.addEventListener("click", () => toggleModal(false));
      els.deleteTask.addEventListener("click", () => {
        if (editingId && confirm("TERMINATE?")) {
          tasks = tasks.filter(x => x.id !== editingId);
          toggleModal(false);
          render();
          saveAll("Terminated");
        }
      });

      function toggleModal(show) {
        els.editModal.classList.toggle("show", show);
      }

      function showToast(msg) {
        els.toast.textContent = msg;
        els.toast.classList.add("show");
        setTimeout(() => els.toast.classList.remove("show"), 2000);
      }

      // --- BACKEND API ---
      
      const API = {
        async fetch() {
          const r = await fetch("/api/tasks");
          if (!r.ok) throw new Error("Net Err");
          return r.json();
        },
        async save(allTasks) {
          await fetch("/api/save", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({tasks: allTasks})
          });
        }
      };

      async function saveAll(msg) {
        if (!isAdmin()) return;
        try {
          await API.save(tasks);
          showToast(msg);
        } catch {
          showToast("Sync Error");
        }
      }

      function connectWS() {
        const proto = location.protocol === "https:" ? "wss" : "ws";
        try {
          ws = new WebSocket(`${proto}://${location.host}/ws`);
          ws.onmessage = (ev) => {
            const msg = JSON.parse(ev.data);
            if (msg.type === "set" || msg.type === "init") {
              if (msg.version && msg.version <= serverVersion) return;
              serverVersion = msg.version || serverVersion + 1;
              tasks = msg.tasks || [];
              render();
              
              // Check for completions
              if (tasks.some(t => computePct(t) >= 100 && !t.celebrated)) {
                // simple confetti trigger if you have the lib
                // Confetti.celebrate(); 
              }
            }
          };
          ws.onclose = () => setTimeout(connectWS, 1000);
        } catch { setTimeout(connectWS, 1000); }
      }

      // --- BOOT ---
      
      async function boot() {
        // Auth check logic
        let authenticated = false;
        try {
          const r = await fetch("/api/auth/status");
          const d = await r.json();
          authenticated = d.authenticated;
        } catch { authenticated = false; }
        
        document.body.classList.toggle("admin-on", authenticated);
        
        // Initial Load
        try {
          const data = await API.fetch();
          tasks = data.tasks || [];
          serverVersion = data.version || 0;
          render();
        } catch (e) { console.log("Offline or clean slate"); }

        connectWS();
        setInterval(render, 1000); // Update timers
        
        // Confetti Engine (Minimalist Version)
        const C = document.getElementById("confettiCanvas");
        const ctx = C.getContext("2d");
        let particles = [];
        window.addEventListener("resize", () => { C.width=window.innerWidth; C.height=window.innerHeight; });
        window.dispatchEvent(new Event("resize"));
        
        // Add celebrate to window for global access if needed
        window.Confetti = {
          celebrate: () => {
            for(let i=0; i<100; i++) {
              particles.push({
                x: C.width/2, y: C.height/2,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                color: PRESETS[Math.floor(Math.random()*PRESETS.length)][0],
                life: 100
              });
            }
          }
        };
        
        function loop() {
          ctx.clearRect(0,0,C.width,C.height);
          particles.forEach((p,i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life--;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 4, 4);
          });
          particles = particles.filter(p=>p.life>0);
          requestAnimationFrame(loop);
        }
        loop();
      }

      boot();
    </script>
  </body>
</html>
