<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Z - SYSTEM // MINIMAL</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet" />

    <style>
      :root {
        /* Minimalist Dark Palette */
        --bg: #0e0e10;
        --surface: #18181b;
        --surface-highlight: #27272a;
        
        --text-main: #f4f4f5;
        --text-muted: #a1a1aa;
        
        --border: #3f3f46;
        --border-focus: #e4e4e7;
        
        /* Accents */
        --accent-primary: #10b981; /* Green */
        --accent-danger: #ef4444;  /* Red */
        --accent-priority: #eab308; /* Yellow/Gold */
        
        /* Dimensions */
        --pixel-shadow: 4px 4px 0px 0px rgba(0,0,0,0.4);
        --pixel-shadow-hover: 6px 6px 0px 0px rgba(0,0,0,0.6);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        background-color: var(--bg);
        /* Subtle dot grid pattern */
        background-image: radial-gradient(var(--border) 1px, transparent 0);
        background-size: 20px 20px;
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        height: 100vh;
        overflow-x: hidden;
      }

      /* --- LAYOUT --- */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 60px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 20px;
      }

      .brand h1 {
        font-family: 'Press Start 2P', monospace;
        font-size: 20px;
        margin: 0;
        line-height: 1.5;
        color: var(--text-main);
      }
      .brand span {
        color: var(--text-muted);
        font-size: 12px;
        font-family: 'VT323', monospace;
        letter-spacing: 2px;
        display: block;
      }

      /* --- BUTTONS (Hard Pixel Style) --- */
      .btn {
        background: var(--surface);
        border: 2px solid var(--border);
        color: var(--text-main);
        padding: 10px 20px;
        font-family: 'VT323', monospace;
        font-size: 18px;
        text-transform: uppercase;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: transform 0.1s, box-shadow 0.1s;
        box-shadow: var(--pixel-shadow);
      }
      .btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: var(--pixel-shadow-hover);
        border-color: var(--text-main);
      }
      .btn:active {
        transform: translate(0, 0);
        box-shadow: none;
      }
      
      .btn.primary {
        background: var(--text-main);
        color: var(--bg);
        border-color: var(--text-main);
        font-weight: bold;
      }
      .btn.danger {
        border-color: var(--accent-danger);
        color: var(--accent-danger);
      }
      .btn.danger:hover {
        background: var(--accent-danger);
        color: white;
      }

      /* --- GRID & CARDS --- */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 30px;
      }

      .card {
        background: var(--surface);
        border: 2px solid var(--border);
        padding: 0;
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: var(--pixel-shadow);
        border-color: var(--border-focus);
      }

      /* Color Bar Strip */
      .card-strip {
        height: 6px;
        background: linear-gradient(90deg, var(--c1, #333), var(--c2, #666));
        border-bottom: 2px solid var(--border);
      }

      /* --- PRIORITY STYLE (High Visibility) --- */
      .card.focused {
        border: 2px solid var(--accent-priority);
        box-shadow: 6px 6px 0px var(--accent-priority);
        transform: translate(-2px, -2px);
        animation: pulseBorder 3s infinite;
      }
      /* Diagonal stripes pattern for priority background */
      .card.focused::before {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          45deg,
          rgba(234, 179, 8, 0.03),
          rgba(234, 179, 8, 0.03) 10px,
          transparent 10px,
          transparent 20px
        );
        pointer-events: none;
        z-index: 0;
      }

      @keyframes pulseBorder {
        0%, 100% { border-color: var(--accent-priority); }
        50% { border-color: #fff; }
      }

      .card-inner {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
        z-index: 1;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        gap: 10px;
      }

      .card-title {
        font-family: 'Press Start 2P', cursive;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-main);
        margin: 0;
      }

      /* Chips/Badges */
      .badge {
        font-family: 'VT323', monospace;
        font-size: 14px;
        padding: 2px 6px;
        border: 1px solid var(--border);
        text-transform: uppercase;
        color: var(--text-muted);
        background: var(--bg);
      }
      .badge.priority {
        background: var(--accent-priority);
        color: #000;
        border-color: var(--accent-priority);
        font-weight: bold;
        animation: blink 2s steps(2) infinite;
      }
      .badge.done {
        background: var(--accent-primary);
        color: #000;
        border-color: var(--accent-primary);
      }
      @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0.5;} }

      /* Description Block */
      .card-desc {
        background: #111;
        border: 1px solid var(--border);
        padding: 10px;
        font-family: 'VT323', monospace;
        font-size: 18px;
        color: #ccc;
        margin-bottom: 15px;
        white-space: pre-wrap; /* Mantiene saltos de l√≠nea */
        line-height: 1.3;
        min-height: 40px;
      }

      /* Progress */
      .progress-wrap {
        margin-top: auto;
      }
      .progress-bar {
        height: 16px;
        border: 2px solid var(--text-main);
        background: var(--bg);
        padding: 2px;
        margin-bottom: 5px;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--c1), var(--c2));
        width: var(--w);
        transition: width 0.4s ease;
      }
      .progress-meta {
        display: flex;
        justify-content: space-between;
        font-family: 'VT323', monospace;
        font-size: 16px;
        color: var(--text-muted);
      }

      /* Admin Actions */
      .actions {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .icon-btn {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-muted);
        cursor: pointer;
        padding: 5px;
      }
      .icon-btn:hover {
        color: var(--text-main);
        background: var(--surface-highlight);
        border-color: var(--border);
      }
      .icon-btn.focus-toggle {
        color: var(--accent-priority);
      }
      .icon-btn.focus-toggle.active {
        background: var(--accent-priority);
        color: #000;
      }

      /* --- EDIT MODAL --- */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        display: none;
        place-items: center;
        z-index: 100;
      }
      .modal.show { display: grid; }
      
      .modal-box {
        background: var(--surface);
        border: 2px solid var(--text-main);
        padding: 30px;
        width: 100%;
        max-width: 500px;
        box-shadow: 8px 8px 0px #000;
      }
      
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
      .form-group { margin-bottom: 15px; }
      
      label {
        display: block;
        font-family: 'VT323', monospace;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 5px;
        font-size: 18px;
      }
      
      input, select, textarea {
        width: 100%;
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 10px;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        outline: none;
      }
      textarea { font-family: 'VT323', monospace; font-size: 18px; resize: vertical; min-height: 100px; }
      
      input:focus, select:focus, textarea:focus {
        border-color: var(--text-main);
      }

      /* Color Picker Grid */
      .color-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
      }
      .color-swatch {
        height: 30px;
        cursor: pointer;
        border: 2px solid transparent;
        background: linear-gradient(135deg, var(--s1), var(--s2));
      }
      .color-swatch:hover { transform: scale(1.1); }
      .color-swatch.selected { border-color: #fff; box-shadow: 0 0 0 2px #000; }

      /* --- LOGIC VISIBILITY --- */
      /* Ocultar elementos de admin por defecto */
      .admin-only { display: none !important; }
      
      /* Mostrar solo si el body tiene clase admin-mode */
      body.admin-mode .admin-only { display: flex !important; }
      
      /* FAB Button */
      .fab {
        position: fixed;
        bottom: 40px;
        right: 40px;
        width: 56px;
        height: 56px;
        background: var(--text-main);
        color: var(--bg);
        border: none;
        box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        font-size: 24px;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: transform 0.1s;
      }
      .fab:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0 rgba(0,0,0,0.7); }
      
      /* Viewer Tag for Read-only */
      .viewer-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        font-family: 'VT323';
        color: var(--text-muted);
        opacity: 0.5;
      }

    </style>
  </head>
  <body>
    
    <canvas id="confettiCanvas" style="position:fixed;inset:0;pointer-events:none;z-index:99;"></canvas>

    <div class="container">
      <header>
        <div class="brand">
          <h1>Z-TASK_MNML</h1>
          <span>v2.4 // SYSTEM READY</span>
        </div>
        <div class="nav">
          <a href="/admin/task.html" class="btn" id="loginBtn">Admin Access</a>
          <a href="/task.html" class="btn admin-only" style="margin-left:10px;">Viewer Mode</a>
        </div>
      </header>

      <div class="grid" id="taskGrid">
        </div>
    </div>

    <button class="fab admin-only" id="addTaskBtn">+</button>

    <div class="modal" id="modal">
      <div class="modal-box">
        <h2 style="margin-top:0; font-family:'Press Start 2P'; font-size:16px;">EDIT TASK DATA</h2>
        
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="inpTitle" placeholder="Task identifier...">
        </div>
        
        <div class="form-row">
          <div>
            <label>Mode</label>
            <select id="inpMode">
              <option value="manual">Manual %</option>
              <option value="time">Time Auto</option>
            </select>
          </div>
          <div id="grpManual">
            <label>Progress (<span id="lblPercent">0%</span>)</label>
            <input type="range" id="inpPercent" min="0" max="100" step="5">
          </div>
        </div>

        <div class="form-row" id="grpTime" style="display:none;">
          <div><label>Start</label><input type="datetime-local" id="inpStart"></div>
          <div><label>End</label><input type="datetime-local" id="inpEnd"></div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="inpDesc" placeholder="Line 1&#10;Line 2 (Will be preserved)"></textarea>
        </div>

        <div class="form-group">
          <label>Color Identifier</label>
          <div class="color-grid" id="colorGrid"></div>
          <input type="hidden" id="inpC1">
          <input type="hidden" id="inpC2">
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px;">
          <button class="btn danger" id="btnDelete">DELETE</button>
          <div>
            <button class="btn" id="btnCancel" style="margin-right:10px;">CANCEL</button>
            <button class="btn primary" id="btnSave">SAVE</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- CONFIGURATION ---
      // Detect if we are in the admin path
      const ADMIN_MODE = window.location.pathname.startsWith("/admin");
      
      if (ADMIN_MODE) {
        document.body.classList.add("admin-mode");
        document.getElementById('loginBtn').style.display = 'none'; // Hide login btn if already in admin
      } else {
        // We are in viewer mode
        document.body.innerHTML += '<div class="viewer-indicator">READ ONLY MODE</div>';
      }

      // --- STATE ---
      let tasks = [];
      let editingId = null;
      let serverVersion = 0;
      
      // --- PRESETS ---
      const COLORS = [
        ['#ef4444', '#f87171'], // Red
        ['#f97316', '#fb923c'], // Orange
        ['#eab308', '#facc15'], // Yellow
        ['#10b981', '#34d399'], // Emerald
        ['#06b6d4', '#22d3ee'], // Cyan
        ['#3b82f6', '#60a5fa'], // Blue
        ['#8b5cf6', '#a78bfa'], // Violet
        ['#d946ef', '#e879f9'], // Fuchsia
        ['#ffffff', '#a1a1aa'], // Monochrome
        ['#14b8a6', '#06b6d4'], // Teal
        ['#f43f5e', '#fb7185'], // Rose
        ['#84cc16', '#a3e635']  // Lime
      ];

      // --- DOM ELEMENTS ---
      const els = {
        grid: document.getElementById('taskGrid'),
        modal: document.getElementById('modal'),
        // Inputs
        title: document.getElementById('inpTitle'),
        mode: document.getElementById('inpMode'),
        percent: document.getElementById('inpPercent'),
        lblPercent: document.getElementById('lblPercent'),
        start: document.getElementById('inpStart'),
        end: document.getElementById('inpEnd'),
        desc: document.getElementById('inpDesc'),
        c1: document.getElementById('inpC1'),
        c2: document.getElementById('inpC2'),
        // Groups
        grpManual: document.getElementById('grpManual'),
        grpTime: document.getElementById('grpTime'),
        colorGrid: document.getElementById('colorGrid'),
        // Buttons
        btnSave: document.getElementById('btnSave'),
        btnCancel: document.getElementById('btnCancel'),
        btnDelete: document.getElementById('btnDelete'),
        btnAdd: document.getElementById('addTaskBtn')
      };

      // --- INITIALIZATION ---
      
      // Build Color Picker
      COLORS.forEach(([c1, c2]) => {
        const div = document.createElement('div');
        div.className = 'color-swatch';
        div.style.setProperty('--s1', c1);
        div.style.setProperty('--s2', c2);
        div.onclick = () => selectColor(c1, c2, div);
        els.colorGrid.appendChild(div);
      });

      function selectColor(c1, c2, el) {
        els.c1.value = c1;
        els.c2.value = c2;
        document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('selected'));
        if(el) el.classList.add('selected');
        else {
          // Find matching visual element
          // (Simpler implementation for now)
        }
      }

      // --- HELPERS ---
      const computePct = (t) => {
        if(t.mode !== 'time') return parseInt(t.percent || 0);
        if(!t.start || !t.end) return 0;
        const s = new Date(t.start).getTime();
        const e = new Date(t.end).getTime();
        const n = Date.now();
        if(e <= s) return 100;
        const p = ((n-s)/(e-s))*100;
        return Math.max(0, Math.min(100, p));
      };

      const escapeHtml = (str) => {
        if(!str) return "";
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      };

      const formatTimeLeft = (t) => {
        if(t.mode !== 'time') return "";
        const now = Date.now();
        const e = new Date(t.end).getTime();
        if(now >= e) return "COMPLETED";
        const diff = (e - now) / 1000; // seconds
        const d = Math.floor(diff / 86400);
        const h = Math.floor((diff % 86400) / 3600);
        return `${d}d ${h}h REMAINING`;
      };

      // --- RENDER ---
      function render() {
        if(tasks.length === 0) {
          els.grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; border:2px dashed var(--border); color:var(--text-muted); font-family:'VT323'; font-size:24px;">NO ACTIVE TASKS</div>`;
          return;
        }

        els.grid.innerHTML = tasks.map(t => {
          const pct = Math.round(computePct(t));
          const isDone = pct >= 100;
          const isFocused = t.focused;
          
          let badges = [];
          if(isFocused) badges.push('<span class="badge priority">PRIORITY</span>');
          if(isDone) badges.push('<span class="badge done">DONE</span>');
          if(t.mode === 'time') badges.push('<span class="badge">AUTO</span>');
          
          return `
          <div class="card ${isFocused ? 'focused' : ''}" data-id="${t.id}" style="--c1:${t.c1}; --c2:${t.c2}">
            <div class="card-strip"></div>
            <div class="card-inner">
              <div class="card-header">
                <h3 class="card-title">${escapeHtml(t.title)}</h3>
                <div style="display:flex; gap:5px;">${badges.join('')}</div>
              </div>
              
              ${t.desc ? `<div class="card-desc">${escapeHtml(t.desc)}</div>` : ''}
              
              <div class="progress-wrap">
                <div class="progress-bar">
                  <div class="progress-fill" style="--w:${pct}%"></div>
                </div>
                <div class="progress-meta">
                  <span>${pct}% COMPLETE</span>
                  <span>${formatTimeLeft(t)}</span>
                </div>
              </div>

              <div class="actions admin-only">
                <button class="icon-btn focus-toggle ${isFocused?'active':''}" onclick="toggleFocus('${t.id}', event)" title="Toggle Priority">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l3 7h7l-5 5 2 7-7-5-7 5 2-7-5-5h7z"/> </svg>
                </button>
                <button class="icon-btn" onclick="openEdit('${t.id}', event)" title="Edit">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          `;
        }).join('');
      }

      // --- ACTIONS (Only work if ADMIN_MODE is true logically, though hidden by CSS) ---

      window.toggleFocus = (id, e) => {
        e.stopPropagation();
        if(!ADMIN_MODE) return;
        const t = tasks.find(x => x.id === id);
        if(t) {
          t.focused = !t.focused;
          saveTasks();
          render();
        }
      };

      window.openEdit = (id, e) => {
        e && e.stopPropagation();
        if(!ADMIN_MODE) return;
        
        editingId = id;
        const t = id ? tasks.find(x => x.id === id) : null;
        
        els.title.value = t ? t.title : "";
        els.desc.value = t ? t.desc : "";
        els.mode.value = t ? t.mode : "manual";
        els.percent.value = t ? (t.percent || 0) : 0;
        els.lblPercent.innerText = els.percent.value + "%";
        
        // Dates
        const dateStr = d => d ? new Date(d).toISOString().slice(0,16) : "";
        els.start.value = t ? dateStr(t.start) : "";
        els.end.value = t ? dateStr(t.end) : "";
        
        // Color
        const c1 = t ? t.c1 : COLORS[0][0];
        const c2 = t ? t.c2 : COLORS[0][1];
        selectColor(c1, c2, null);
        
        updateFormVisibility();
        els.modal.classList.add('show');
      };

      function saveTasks() {
        if(!ADMIN_MODE) return;
        fetch('/api/save', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({tasks})
        }).catch(err => console.error(err));
      }

      // --- EVENT LISTENERS ---

      if (ADMIN_MODE) {
        els.btnAdd.addEventListener('click', () => openEdit(null));
        
        els.btnSave.addEventListener('click', () => {
          const title = els.title.value.trim();
          if(!title) return alert("Title required");
          
          const mode = els.mode.value;
          const newTask = {
            id: editingId || Math.random().toString(36).substr(2, 9),
            title,
            desc: els.desc.value,
            mode,
            percent: mode === 'manual' ? parseInt(els.percent.value) : 0,
            start: mode === 'time' && els.start.value ? new Date(els.start.value).toISOString() : null,
            end: mode === 'time' && els.end.value ? new Date(els.end.value).toISOString() : null,
            c1: els.c1.value,
            c2: els.c2.value,
            focused: editingId ? (tasks.find(t => t.id === editingId)?.focused || false) : false
          };

          if(editingId) {
            const idx = tasks.findIndex(t => t.id === editingId);
            if(idx > -1) tasks[idx] = newTask;
          } else {
            tasks.unshift(newTask);
          }

          els.modal.classList.remove('show');
          saveTasks();
          render();
        });

        els.btnDelete.addEventListener('click', () => {
          if(editingId && confirm("Delete task?")) {
            tasks = tasks.filter(t => t.id !== editingId);
            saveTasks();
            render();
            els.modal.classList.remove('show');
          }
        });

        // Toggle Manual/Time inputs
        els.mode.addEventListener('change', updateFormVisibility);
        els.percent.addEventListener('input', (e) => els.lblPercent.innerText = e.target.value + "%");
      }

      els.btnCancel.addEventListener('click', () => els.modal.classList.remove('show'));

      function updateFormVisibility() {
        const isTime = els.mode.value === 'time';
        els.grpTime.style.display = isTime ? 'grid' : 'none';
        els.grpManual.style.display = isTime ? 'none' : 'block';
      }

      // --- BACKEND SYNC ---
      async function loadData() {
        try {
          const res = await fetch('/api/tasks');
          const data = await res.json();
          tasks = data.tasks || [];
          render();
        } catch(e) { console.log("Offline mode"); }
      }

      function connectWS() {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${proto}://${location.host}/ws`);
        ws.onmessage = (e) => {
          const msg = JSON.parse(e.data);
          if(msg.type === 'set' || msg.type === 'init') {
            tasks = msg.tasks || [];
            render();
          }
        };
        ws.onclose = () => setTimeout(connectWS, 2000);
      }

      // Boot
      loadData();
      connectWS();
      setInterval(render, 5000); // Update timers periodically

    </script>
  </body>
</html>
